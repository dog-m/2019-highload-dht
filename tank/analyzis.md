# Нагрузочное тестирование Яндекс.Танком
_Примечание: тестирование проводилось в среде Oracle VM VirtualBox 6.0.14 по причине невозможности использования реального оборудования_

## Подготовка
Был написан [генератор патронов](../src/main/java/ru/mail/polis/service/dogm/AmmoGenerator.java) по аналогии с тем, что был показан на лекции.
Затем была проведена [пробная стрельба](https://overload.yandex.net/230524) запросами типа **PUT** для определения _рабочего_ уровня нагрузки.
Разладка системы была достигнута уже при **86** запросах `PUT` в секунду (RPS).
Далее было выбрано в качестве предельного значение в **80** RPS.

## Проведение тестирования
Тестирование было выполнено с запросами типа:
* **PUT** с уникальными ключами. [Результаты](https://overload.yandex.net/230652).
* **PUT** с частичной перезаписью ключей _(вероятность 10%)_. [Результаты](https://overload.yandex.net/230654).
* **GET** с равномерным распределением. [Результаты](https://overload.yandex.net/230657).
* **GET** со _смещением_ распределения. [Результаты](https://overload.yandex.net/230659).
* **Смешанная нагрузка** с 50% **PUT** и 50% **GET** существующих ключей _(равномерное распределение)_. [Результаты](https://overload.yandex.net/230663).

Наиболее репрезентативные результаты (смешанная нагрузка):

```
Percentiles (all/last 1m/last), ms:
 100.0% <  1,145.0  127.0  10.6
  99.5% <    555.0   38.0  10.6
  99.0% <    492.0   28.0   9.6
  95.0% <    123.0   14.0   7.5
  90.0% <     41.0   10.0   6.0
  85.0% <     17.0    7.9   4.8
  80.0% <     12.0    6.7   4.5
  75.0% <      8.5    5.6   4.5
  70.0% <      6.9    5.0   4.2
  60.0% <      5.1    4.3   4.0
  50.0% <      4.3    3.9   3.7
  40.0% <      3.8    3.6   3.5
  30.0% <      3.5    3.4   3.4
  20.0% <      3.3    3.2   3.1
  10.0% <      3.0    2.9   2.9
```


## Выводы
~~Всё очень плохо~~

Поскольку замеры выполнялись в виртуальном окружении VM VirtualBox, не удалось достичь сколько-нибудь разумных/полезных значений числа RPS.
Было замечено, что входной узел кластера в начале тестирования иногда выдаёт ошибку 504 по неизвестной причине.

Результаты тестирования Яндекс.Танком в некоторой степени соответствуют рзультатам профилирования с использованием wrk2.
